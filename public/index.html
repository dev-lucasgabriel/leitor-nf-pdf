<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processador de Documentos</title>
    <style>
        /* Cores principais */
        :root {
            --vermelho: #c62828;
            --vermelho-escuro: #8b0000;
            --branco: #ffffff;
            --cinza-claro: #f7f7f7;
            --cinza-escuro: #333333;
            --verde-excel: #2E7D32; 
            --azul-pdf: #931c1c;
        }

        /* Reset b√°sico */
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            margin: 0;
            background-color: var(--branco);
            color: var(--cinza-escuro);
            padding: 40px 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1, h2 {
            color: var(--vermelho);
            margin-bottom: 10px;
            user-select: none;
        }

        /* --- Global Container Style --- */
        .main-container {
            width: 100%;
            max-width: 1000px;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            background-color: var(--cinza-claro);
            margin-top: 20px;
        }

        /* --- Upload (Step 1) --- */
        #uploadForm {
            width: 100%;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .file-label {
            flex-grow: 1;
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border: 2px solid var(--vermelho);
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            gap: 10px;
        }

        button {
            background-color: var(--vermelho);
            color: var(--branco);
            border: none;
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        button:hover { background-color: var(--vermelho-escuro); }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* --- Sele√ß√£o de Campos (Step 2) --- */
        #selection-area {
            width: 100%;
            padding: 20px 0;
        }
        #fields-checkbox-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #ddd;
            background-color: var(--branco);
        }
        .field-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px;
            border-radius: 4px;
            background-color: #fff;
            user-select: none;
        }
        .field-checkbox input[type="checkbox"]:checked + span {
            font-weight: bold;
            color: var(--verde-excel);
        }
        
        /* --- Mensagens e Resultados --- */
        #statusMessage {
            text-align: center;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .success { color: var(--verde-excel); }
        .error { color: var(--vermelho); }

        .hidden { display: none !important; }
        .result-summary {
            padding: 15px;
            border: 1px solid var(--verde-excel);
            background-color: #f0fff0;
            margin-top: 15px;
            border-radius: 4px;
        }
        
        /* √çcone de Resumo */
        .file-count-text::before {
            content: "üìë";
            margin-right: 8px;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <h1>Processador de Documentos (PDF/IMG)</h1>

    <div class="main-container">
        
        <div id="statusMessage">Aguardando documentos...</div>

        <div id="upload-area">
            <h2>1. Envio e An√°lise</h2>
            <form id="uploadForm">
                <label for="pdfs" class="file-label">
                    <span id="file-count-text" class="file-count-text">Escolher Arquivos (.pdf, .jpg, .png)</span>
                    <input type="file" name="pdfs" id="pdfs" accept="application/pdf, image/jpeg, image/png" multiple required style="display: none;" />
                </label>
                <button type="submit" id="analyzeButton" disabled>Analisar Documentos</button>
            </form>
        </div>

        <div id="selection-area" class="hidden">
            <hr>
            <h2>2. Curadoria de Dados (Passo Interativo)</h2>
            <p>A IA encontrou campos em seus documentos. Selecione os que voc√™ deseja na sua planilha final.</p>

            <div id="summary-info"></div>

            <div id="fields-checkbox-container">
                </div>

            <div style="display: flex; justify-content: space-between; align-items: center;">
                <button id="selectAllButton" type="button" class="excel-download-link" style="background-color: #3f51b5; color: white;">
                    Selecionar Todos
                </button>
                <button id="exportButton" type="button">
                    Gerar Excel Curado
                </button>
            </div>
        </div>
        
    </div> <script>
        // Vari√°veis de Estado
        let currentSessionId = null; 
        
        // Elementos do DOM
        const uploadForm = document.getElementById('uploadForm');
        const fileInput = document.getElementById('pdfs');
        const analyzeButton = document.getElementById('analyzeButton');
        const selectAllButton = document.getElementById('selectAllButton');
        const exportButton = document.getElementById('exportButton');
        const selectionArea = document.getElementById('selection-area');
        const fieldsContainer = document.getElementById('fields-checkbox-container');
        const statusMessage = document.getElementById('statusMessage');
        const fileCountText = document.getElementById('file-count-text');
        const summaryInfo = document.getElementById('summary-info');
        
        
        // --- 1. Fun√ß√µes Utilit√°rias ---
        
        function formatKeyForDisplay(key) {
            // Se for o campo de erro, n√£o formata
            if (key.includes('erro_processamento') || key === 'arquivo_original') return key.replace(/_/g, ' ');
            
            return key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        // --- 2. L√≥gica de UI e Event Listeners ---
        
        fileInput.addEventListener('change', () => {
            const numFiles = fileInput.files.length;
            if (numFiles > 0) {
                fileCountText.textContent = `${numFiles} arquivo(s) selecionado(s).`;
                analyzeButton.disabled = false;
            } else {
                fileCountText.textContent = 'Escolher Arquivos (.pdf, .jpg, .png)';
                analyzeButton.disabled = true;
            }
        });

        // Selecionar Todos / Desmarcar Todos
        selectAllButton.addEventListener('click', () => {
            const checkboxes = fieldsContainer.querySelectorAll('input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(cb => {
                cb.checked = !allChecked;
            });
            selectAllButton.textContent = allChecked ? 'Selecionar Todos' : 'Desmarcar Todos';
        });


        // --- 3. Etapa 1: AN√ÅLISE (Upload e Extra√ß√£o Bruta) ---
        
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(uploadForm);
            
            statusMessage.textContent = '‚è≥ Analisando documentos com IA... (Pode levar um tempo)';
            statusMessage.className = '';
            analyzeButton.disabled = true;
            selectionArea.classList.add('hidden'); // Esconde sele√ß√£o anterior

            try {
                const res = await fetch('/api/analyze', {
                    method: 'POST',
                    body: formData
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.error || `Erro do Servidor: ${res.status}`);
                }

                const data = await res.json();
                
                if (data.availableKeys && data.availableKeys.length > 0) {
                    currentSessionId = data.sessionId;
                    handleAnalyzeResponse(data.availableKeys, fileInput.files.length);
                } else {
                    statusMessage.textContent = '‚ùå A IA n√£o conseguiu extrair nenhum campo relevante dos documentos.';
                    statusMessage.className = 'error';
                    analyzeButton.disabled = false;
                }

            } catch (err) {
                console.error('Erro na Etapa de An√°lise:', err);
                statusMessage.textContent = '‚ùå Erro de Conex√£o ou Servidor. Consulte o console.';
                statusMessage.className = 'error';
            } finally {
                analyzeButton.disabled = false;
            }
        });
        
        // Fun√ß√£o que constr√≥i a √°rea de sele√ß√£o
        function handleAnalyzeResponse(keys, fileCount) {
            fieldsContainer.innerHTML = ''; // Limpa campos antigos
            
            summaryInfo.innerHTML = `
                <p>An√°lise conclu√≠da: **${fileCount} arquivo(s)** analisado(s).
                A IA encontrou **${keys.length} campos √∫nicos** no total.
                Selecione abaixo quais colunas voc√™ deseja no Excel.</p>
            `;
            
            // Ordem de prioridade para marca√ß√£o inicial
            const priorityOrder = ['resumo_executivo', 'valor', 'total', 'data', 'nome', 'arquivo_original'];

            keys.forEach(key => {
                const label = document.createElement('label');
                label.className = 'field-checkbox';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = 'selected_fields';
                checkbox.value = key;
                
                // Marcar os campos mais importantes por padr√£o
                if (priorityOrder.includes(key) || key.includes('valor') || key.includes('total')) {
                    checkbox.checked = true;
                }
                
                const span = document.createElement('span');
                span.textContent = formatKeyForDisplay(key);
                
                label.appendChild(checkbox);
                label.appendChild(span);
                fieldsContainer.appendChild(label);
            });
            
            selectionArea.classList.remove('hidden');
            statusMessage.textContent = '‚úÖ An√°lise conclu√≠da. Selecione os campos e exporte.';
            statusMessage.className = 'success';
            selectAllButton.textContent = 'Selecionar Todos';
        }


        // --- 4. Etapa 2: CURADORIA (Exporta√ß√£o Final) ---

        exportButton.addEventListener('click', async () => {
            if (!currentSessionId) return;

            const selectedCheckboxes = fieldsContainer.querySelectorAll('input[name="selected_fields"]:checked');
            const selectedKeys = Array.from(selectedCheckboxes).map(cb => cb.value);

            // Adiciona a chave de rastreamento do arquivo, se ainda n√£o estiver selecionada
            if (!selectedKeys.includes('arquivo_original')) {
                selectedKeys.unshift('arquivo_original');
            }


            if (selectedKeys.length === 0) {
                alert('Selecione pelo menos um campo para exportar!');
                return;
            }

            statusMessage.textContent = '‚è≥ Gerando Excel com campos curados...';
            statusMessage.className = '';
            exportButton.disabled = true;

            try {
                const res = await fetch('/api/export-excel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: currentSessionId,
                        selectedKeys: selectedKeys
                    })
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.error || `Erro de exporta√ß√£o: ${res.status}`);
                }

                // Disparar o download (o servidor Render retorna o arquivo)
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                // O servidor Render n√£o retorna o nome do arquivo, ent√£o criamos um
                a.download = `curadoria_gemini_${Date.now()}.xlsx`; 
                a.href = url;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                
                statusMessage.textContent = 'üéâ Sucesso! O download do Excel curado iniciou. Inicie um novo processo!';
                statusMessage.className = 'success';
                selectionArea.classList.add('hidden'); // Volta para a tela inicial

            } catch (err) {
                console.error('Erro na Etapa de Exporta√ß√£o:', err);
                statusMessage.textContent = '‚ùå Falha na exporta√ß√£o do Excel.';
                statusMessage.className = 'error';
            } finally {
                exportButton.disabled = false;
            }
        });
    </script>
</body>
</html>