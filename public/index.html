<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processador de Documentos</title> <style>
        /* Cores principais */
        :root {
            --vermelho: #c62828;
            --vermelho-escuro: #8b0000;
            --branco: #ffffff;
            --cinza-claro: #f7f7f7;
            --cinza-escuro: #333333;
            --verde-excel: #2E7D32; /* Cor MS Excel */
            --azul-pdf: #931c1c; /* Cor do Acrobat Reader (Usamos uma varia√ß√£o) */
        }

        /* Reset b√°sico */
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            margin: 0;
            background-color: var(--branco);
            color: var(--cinza-escuro);
            padding: 40px 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1, h2 {
            color: var(--vermelho);
            margin-bottom: 10px;
            user-select: none;
        }

        /* --- Formul√°rio e Bot√µes --- */
        form {
            width: 100%;
            max-width: 1200px; /* Ocupa mais espa√ßo */
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .file-label {
            flex-grow: 1;
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border: 2px solid var(--vermelho);
            border-radius: 6px;
            background-color: var(--branco);
            color: var(--cinza-escuro);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            gap: 10px;
        }
        .file-label:hover {
            border-color: var(--vermelho-escuro);
            box-shadow: 0 0 5px rgba(198, 40, 40, 0.5);
        }
        
        button {
            background-color: var(--vermelho);
            color: var(--branco);
            border: none;
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            user-select: none;
        }
        button:hover { background-color: var(--vermelho-escuro); }

        /* --- Estilo do link de download (Visual Excel) --- */
        .excel-download-link {
            font-weight: 700;
            text-decoration: none;
            color: var(--verde-excel); 
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            border: 1px solid var(--verde-excel);
            border-radius: 4px;
            background-color: #E8F5E9;
            transition: all 0.3s ease;
        }
        .excel-download-link:hover {
            background-color: #C8E6C9;
            color: #1B5E20;
        }
        .excel-download-link::before {
            content: "üìä"; /* √çcone simples de planilha/logo */
            font-size: 1.2em;
        }

        /* --- Layout de Resultados (Cards - Preenchendo a Tela) --- */
        #results-container {
            width: 100%;
            max-width: 1200px; 
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap; 
            gap: 20px;
            justify-content: center;
        }

        .result-card {
            background-color: var(--cinza-claro);
            border: 1px solid #ddd;
            border-radius: 8px;
            border-left: 5px solid var(--azul-pdf); /* Linha lateral (Visual Documento/PDF) */
            padding: 15px;
            width: 100%; 
            max-width: 380px; /* 3 colunas em tela grande */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .result-card h3 {
            color: var(--azul-pdf); /* T√≠tulo do documento */
            margin: 0 0 10px 0;
            font-size: 1.1rem;
            border-bottom: 1px dashed #ddd;
            padding-bottom: 5px;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }
        .data-item {
            font-size: 0.95rem;
        }
        .data-item strong {
            display: block;
            color: var(--cinza-escuro);
            font-weight: 600;
        }
        .data-summary {
            font-style: italic;
            font-size: 0.85rem;
            color: #555;
            padding-top: 10px;
        }
        .data-summary strong { color: var(--verde-excel); font-weight: 700; } /* Destaca o link de download */
        
        @media (min-width: 800px) {
            #results-container {
                justify-content: space-between;
            }
            .result-card {
                width: calc(33.33% - 15px); /* 3 colunas */
            }
        }
    </style>
</head>
<body>
    <h1>Processador de Documentos (PDF/IMG)</h1> <form id="uploadForm">
        <label for="pdfs" class="file-label">
            <span id="file-count-text">Escolher Arquivos (.pdf, .jpg, .png)</span>
            <input type="file" name="pdfs" id="pdfs" accept="application/pdf, image/jpeg, image/png" multiple required style="display: none;" />
        </label>
        <button type="submit" id="submitButton">Enviar Documentos</button>
    </form>

    <div id="statusMessage"></div>

    <h2>Resultados da Extra√ß√£o:</h2>
    
    <div id="results-container">
        </div>
    <script>
        const form = document.getElementById('uploadForm');
        const resultsContainer = document.getElementById('results-container');
        const statusMessage = document.getElementById('statusMessage');
        const fileInput = document.getElementById('pdfs');
        const fileCountText = document.getElementById('file-count-text');
        const submitButton = document.getElementById('submitButton');
        
        // --- Fun√ß√µes Utilit√°rias ---
        
        // Fun√ß√£o utilit√°ria para formatar chaves (snake_case para Title Case)
        function formatKey(key) {
            // Se for a chave 'resumo_executivo', retorna algo gen√©rico para o display
            if (key === 'resumo_executivo') return 'Resumo Executivo';
            
            return key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }
        
        // Atualiza o texto do campo de upload
        fileInput.addEventListener('change', () => {
            const numFiles = fileInput.files.length;
            if (numFiles > 0) {
                fileCountText.textContent = `${numFiles} arquivo(s) selecionado(s).`;
                submitButton.disabled = false;
            } else {
                fileCountText.textContent = 'Escolher Arquivos (.pdf, .jpg, .png)';
                submitButton.disabled = true;
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData();
            for (const file of fileInput.files) {
                formData.append('pdfs', file); 
            }

            // --- UI Setup ---
            statusMessage.textContent = '‚è≥ Processando arquivos... Aguarde alguns segundos por documento.';
            statusMessage.className = '';
            resultsContainer.innerHTML = ''; // Limpa resultados anteriores
            submitButton.disabled = true;

            try {
                const res = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.error || `Erro do Servidor: ${res.status}`);
                }

                const { results, sessionId } = await res.json();

                // --- Gera√ß√£o dos Cards Din√¢micos ---
                if (results && results.length > 0) {
                    results.forEach((dado) => {
                        const card = document.createElement('div');
                        card.className = 'result-card';
                        
                        // Encontra as chaves para exibi√ß√£o (ignora 'resumo' para o display principal)
                        const keys = Object.keys(dado).filter(k => k !== 'resumo' && k !== 'arquivo_original');
                        
                        // Pega as duas chaves principais para mostrar nos cards
                        const key1 = keys[0] || 'N/A';
                        const val1 = dado[key1] || 'N/A';
                        const key2 = keys[1] || 'N/A';
                        const val2 = dado[key2] || 'N/A';
                        
                        if (dado.erro) {
                            card.innerHTML = `
                                <h3>${dado.arquivo_original || 'Processamento Falho'}</h3>
                                <p class="error">‚ùå Erro na API: ${dado.erro}</p>
                            `;
                        } else {
                            card.innerHTML = `
                                <h3>${dado.arquivo_original || 'Documento Processado'}</h3>
                                
                                <div class="data-item">
                                    <strong>${formatKey(key1)}:</strong> ${val1}
                                </div>
                                
                                <div class="data-item">
                                    <strong>${formatKey(key2)}:</strong> ${val2}
                                </div>
                                
                                <div class="data-summary">
                                    <strong>Resumo:</strong> ${dado.resumo || 'N/A'}
                                    <p>Clique no link de download para obter **TODOS os ${keys.length} campos** em Excel.</p>
                                </div>
                            `;
                        }
                        resultsContainer.appendChild(card);
                    });

                    // --- Gera√ß√£o do Link de Download do Excel ---
                    const downloadLink = document.createElement('a');
                    downloadLink.href = `/download-excel/${sessionId}`; 
                    downloadLink.textContent = 'Baixar Resultados Completos em Excel';
                    downloadLink.className = 'excel-download-link'; 
                    
                    statusMessage.innerHTML = '';
                    statusMessage.className = 'success';
                    statusMessage.appendChild(downloadLink);

                } else {
                    statusMessage.textContent = 'Nenhum dado v√°lido extra√≠do. Verifique o arquivo e o log do servidor.';
                    statusMessage.className = 'error';
                }

            } catch (err) {
                console.error(err);
                statusMessage.textContent = '‚ùå Erro de Conex√£o ou Servidor: ' + err.message;
                statusMessage.className = 'error';
            } finally {
                submitButton.disabled = false;
                // Reseta a sele√ß√£o de arquivos
                fileCountText.textContent = 'Escolher Arquivos (.pdf, .jpg, .png)';
                fileInput.value = '';
            }
        });
    </script>
</body>
</html>