<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Leitor de Notas Fiscais</title>
  <style>
    /* Cores principais */
    :root {
      --vermelho: #c62828;          /* Vermelho forte */
      --vermelho-escuro: #8b0000;  /* Vermelho escuro para hover */
      --branco: #ffffff;
      --cinza-claro: #f7f7f7;
      --cinza-escuro: #333333;
      --cinza-medio: #666666;
    }

    /* Reset básico */
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--branco);
      color: var(--cinza-escuro);
      padding: 40px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1, h2 {
      color: var(--vermelho);
      margin-bottom: 10px;
      user-select: none;
    }

    /* Form */
    form {
      width: 100%;
      max-width: 900px;
      margin-bottom: 20px;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    input[type="file"] {
      flex-grow: 1;
      padding: 8px;
      border: 2px solid var(--vermelho);
      border-radius: 6px;
      background-color: var(--branco);
      color: var(--cinza-escuro);
      cursor: pointer;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    input[type="file"]:focus {
      outline: none;
      border-color: var(--vermelho-escuro);
      box-shadow: 0 0 5px var(--vermelho);
    }

    button[type="submit"] {
      background-color: var(--vermelho);
      color: var(--branco);
      border: none;
      padding: 10px 20px;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      user-select: none;
    }

    button[type="submit"]:hover,
    button[type="submit"]:focus {
      background-color: var(--vermelho-escuro);
      outline: none;
    }

    /* Status message */
    #statusMessage {
      max-width: 900px;
      font-weight: 600;
      margin-top: 10px;
      min-height: 1.2em;
      user-select: none;
    }

    .success {
      color: #2e7d32; /* verde escuro */
    }

    .error {
      color: var(--vermelho);
    }

    /* Tabela principal */
    table {
      width: 100%;
      max-width: 900px;
      border-collapse: collapse;
      margin-top: 20px;
      border: 2px solid var(--vermelho);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 0 8px rgba(198, 40, 40, 0.4);
      user-select: none;
    }

    thead {
      background-color: var(--vermelho);
      color: var(--branco);
    }

    th, td {
      padding: 12px 15px;
      border-bottom: 1px solid var(--cinza-claro);
      text-align: left;
      font-size: 0.95rem;
    }

    tbody tr:hover {
      background-color: var(--cinza-claro);
    }

    tbody tr:nth-child(even) {
      background-color: #fff5f5;
    }

    /* Tabela produtos dentro da linha expandida */
    .produto-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .produto-table thead {
      background-color: #ef9a9a;
      color: var(--branco);
    }

    .produto-table th,
    .produto-table td {
      padding: 8px 10px;
      border: 1px solid var(--vermelho);
      font-size: 0.9rem;
    }

    /* Linha de produtos oculta */
    .hidden {
      display: none;
    }

    /* Botão toggle */
    .toggle-button {
      cursor: pointer;
      color: var(--branco);
      background-color: var(--vermelho-escuro);
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      font-size: 0.9rem;
      font-weight: 600;
      transition: background-color 0.3s ease;
      user-select: none;
    }

    .toggle-button:hover,
    .toggle-button:focus {
      background-color: #5c0000;
      outline: none;
    }

    /* Responsividade simples */
    @media (max-width: 1024px) {
      form {
        flex-direction: column;
        align-items: stretch;
      }

      input[type="file"], button[type="submit"] {
        width: 100%;
      }

      table, .produto-table {
        font-size: 0.85rem;
      }
    }
  </style>
</head>
<body>
  <h1>Processador de Notas Fiscais (PDF)</h1>

  <form id="uploadForm">
    <input type="file" name="pdfs" id="pdfs" accept="application/pdf" multiple required />
    <button type="submit">Enviar PDFs</button>
  </form>

  <p id="statusMessage"></p>

  <h2>Resultados:</h2>
  <table id="resultadoTable" class="hidden" aria-live="polite" aria-label="Tabela de resultados">
    <thead>
      <tr>
        <th>Arquivo</th>
        <th>Número Nota</th>
        <th>Série</th>
        <th>Data Emissão</th>
        <th>Data Entrada/Saída</th>
        <th>Natureza da Operação</th>
        <th>Valor Total</th>
        <th>ICMS</th>
        <th>ICMS ST</th>
        <th>Valor Produtos</th>
        <th>Qtde Produtos</th>
        <th>Produtos</th>
      </tr>
    </thead>
    <tbody id="resultadoBody">
      <!-- Os dados virão aqui -->
    </tbody>
  </table>

  <script>
    const form = document.getElementById('uploadForm');
    const table = document.getElementById('resultadoTable');
    const tbody = document.getElementById('resultadoBody');
    const statusMessage = document.getElementById('statusMessage');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const input = document.getElementById('pdfs');
      const formData = new FormData();

      for (const file of input.files) {
        formData.append('pdfs', file);
      }

      try {
        statusMessage.textContent = '⏳ Processando arquivos...';
        statusMessage.className = '';

        const res = await fetch('/upload', {
          method: 'POST',
          body: formData
        });

        if (!res.ok) throw new Error('Erro ao processar os PDFs');

        const resultados = await res.json();

        // Limpar tabela
        tbody.innerHTML = '';

        resultados.forEach((dado, index) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${dado.arquivo}</td>
            <td>${dado.numeroNota}</td>
            <td>${dado.serie}</td>
            <td>${dado.dataEmissao}</td>
            <td>${dado.dataEntradaSaida}</td>
            <td>${dado.naturezaOperacao}</td>
            <td>${dado.valorTotalNota}</td>
            <td>${dado.valorIcms}</td>
            <td>${dado.valorIcmsSt}</td>
            <td>${dado.valorTotalProdutos}</td>
            <td>${dado.produtos.length}</td>
            <td>
              <button class="toggle-button" aria-expanded="false" aria-controls="produtos-${index}" onclick="toggleProdutos(${index}, this)">Ver Produtos</button>
            </td>
          `;
          tbody.appendChild(row);

          // Linha oculta com a tabela de produtos
          const produtoRow = document.createElement('tr');
          produtoRow.id = `produtos-${index}`;
          produtoRow.classList.add('hidden');
          produtoRow.innerHTML = `
            <td colspan="12">
              <table class="produto-table" aria-label="Produtos da nota ${dado.numeroNota}">
                <thead>
                  <tr>
                    <th>Código</th>
                    <th>Descrição</th>
                    <th>NCM</th>
                  </tr>
                </thead>
                <tbody>
                  ${dado.produtos.map(prod =>
                    `<tr>
                      <td>${prod.codigo}</td>
                      <td>${prod.descricao}</td>
                      <td>${prod.ncm}</td>
                    </tr>`).join('')}
                </tbody>
              </table>
            </td>
          `;
          tbody.appendChild(produtoRow);
        });

        table.classList.remove('hidden');
        statusMessage.textContent = `✅ ${resultados.length} arquivo(s) processado(s) com sucesso.`;
        statusMessage.className = 'success';

      } catch (err) {
        console.error(err);
        statusMessage.textContent = '❌ ' + err.message;
        statusMessage.className = 'error';
      }
    });

    function toggleProdutos(index, btn) {
      const row = document.getElementById(`produtos-${index}`);
      const isHidden = row.classList.toggle('hidden');
      btn.setAttribute('aria-expanded', !isHidden);
      btn.textContent = isHidden ? 'Ver Produtos' : 'Esconder Produtos';
    }
  </script>
</body>
</html>
